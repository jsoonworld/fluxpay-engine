#!/bin/bash

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits
if echo "$COMMIT_MSG" | grep -qE "^Merge"; then
    exit 0
fi

# =============================================================================
# COMMIT MESSAGE FORMAT VALIDATION
# =============================================================================
# Expected format:
#   <type>: <subject>
#
#   [optional body]
#
# Types: feat, fix, refactor, test, docs, chore

VALID_TYPES="feat|fix|refactor|test|docs|chore"

# Get the first line (subject)
SUBJECT=$(echo "$COMMIT_MSG" | head -1)

# Check format: type: subject
if ! echo "$SUBJECT" | grep -qE "^($VALID_TYPES): .+"; then
    echo ""
    echo -e "${RED}ERROR: Invalid commit message format!${NC}"
    echo ""
    echo "Expected format: <type>: <subject>"
    echo ""
    echo "Valid types:"
    echo "  feat     - New feature"
    echo "  fix      - Bug fix"
    echo "  refactor - Code refactoring (no functional change)"
    echo "  test     - Adding or updating tests"
    echo "  docs     - Documentation changes"
    echo "  chore    - Build, CI, or tooling changes"
    echo ""
    echo "Examples:"
    echo "  feat: Add payment validation"
    echo "  fix: Prevent duplicate order creation"
    echo "  test: Add Order state transition tests"
    echo ""
    echo "Your message: $SUBJECT"
    echo ""
    exit 1
fi

# Check subject length (max 72 characters)
SUBJECT_LENGTH=${#SUBJECT}
if [ "$SUBJECT_LENGTH" -gt 72 ]; then
    echo ""
    echo -e "${YELLOW}WARNING: Commit subject too long!${NC}"
    echo "  Length: $SUBJECT_LENGTH (recommended: â‰¤ 72)"
    echo "  Subject: $SUBJECT"
    echo ""
fi

# Check that subject doesn't end with period
if echo "$SUBJECT" | grep -qE "\.$"; then
    echo ""
    echo -e "${YELLOW}WARNING: Commit subject should not end with a period.${NC}"
    echo ""
fi

# Check that type is lowercase
TYPE=$(echo "$SUBJECT" | grep -oE "^[a-zA-Z]+" | head -1)
if ! echo "$TYPE" | grep -qE "^[a-z]+$"; then
    echo ""
    echo -e "${RED}ERROR: Commit type should be lowercase!${NC}"
    echo "  Found: $TYPE"
    echo "  Expected: $(echo "$TYPE" | tr '[:upper:]' '[:lower:]')"
    echo ""
    exit 1
fi

echo -e "${GREEN}Commit message format OK.${NC}"
exit 0
