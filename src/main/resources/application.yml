spring:
  application:
    name: fluxpay-engine

  # R2DBC PostgreSQL
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/fluxpay
    username: ${DB_USERNAME:fluxpay}
    password: ${DB_PASSWORD:fluxpay}
    pool:
      initial-size: 10
      max-size: 50

  # Redis
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}

  # Kafka
  kafka:
    bootstrap-servers: ${KAFKA_SERVERS:localhost:9092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer
    consumer:
      group-id: fluxpay-engine
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: com.fluxpay.engine

  # Jackson
  jackson:
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false

server:
  port: 8080

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  health:
    r2dbc:
      enabled: true
    redis:
      enabled: true

# Logging
logging:
  level:
    root: INFO
    com.fluxpay: DEBUG
    org.springframework.r2dbc: DEBUG

# OpenAPI
springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method

# FluxPay Custom Config
fluxpay:
  pg:
    toss:
      api-url: https://api.tosspayments.com/v1
      secret-key: ${TOSS_SECRET_KEY}
      connect-timeout: 3s
      read-timeout: 10s

  credit:
    default-currency: KRW

  queue:
    waiting-room:
      enabled: true
      max-concurrent-users: 1000
      entry-rate-per-second: 100

  tenant:
    enabled: false  # default disabled for test compatibility

  idempotency:
    enabled: true
    ttl: 24h
    redis:
      key-prefix: idempotency
      timeout: 3s

  saga:
    enabled: true
    timeout: 30s                    # Saga total timeout
    step-timeout: 10s               # Individual step timeout
    compensation:
      max-retries: 3                # Compensation retry count
      retry-delay: 1s               # Retry interval
    cleanup:
      enabled: true
      retention-days: 30            # Completed saga retention period
      cron: "0 0 2 * * *"           # Daily cleanup at 2 AM

  tenants:
    configs:
      default:
        rate-limit: 100
        credit-enabled: false
        subscription-enabled: false
        webhook-url: ""
      service-a:
        rate-limit: 1000
        credit-enabled: true
        subscription-enabled: false
        webhook-url: "https://service-a.com/webhooks"
