# FluxPay Engine - Product Brief

> **Version**: 1.0 | **Status**: Draft | **Last Updated**: 2026-02-04
>
> This document provides comprehensive product details. For a quick overview, see the [Executive Summary (1-Pager)](./1-pager.md).

---

## 한 줄 요약

**어떤 서비스에도 붙일 수 있는 플러그인형 결제/과금 엔진**

---

## 해결하려는 문제 (Pain Points)

### 1. 반복되는 결제 시스템 구축
새로운 유료 기능을 도입할 때마다 결제 로직을 처음부터 다시 구현해야 한다. PG 연동, 멱등성 처리, 환불 로직 등 동일한 작업이 반복된다.

### 2. 분산 환경에서의 데이터 정합성
결제는 성공했는데 서비스 실행이 실패하면? 여러 시스템에 걸친 트랜잭션에서 데이터 불일치가 발생하고, 수동으로 보정해야 하는 상황이 빈번하다.

### 3. 트래픽 폭주 시 시스템 보호 부재
선착순 이벤트, 대규모 프로모션 시 결제 시스템 과부하로 전체 서비스가 다운되는 문제가 발생한다.

---

## 목표 사용자 (Target Users)

| 사용자 | 니즈 |
|--------|------|
| **백엔드 개발자** | 결제 로직을 직접 구현하지 않고, API 호출만으로 결제 기능 연동 |
| **프로덕트 매니저** | 크레딧, 구독, 종량제 등 다양한 과금 모델을 빠르게 실험 |
| **운영팀** | 결제 현황 모니터링, 이상 거래 탐지, 장애 시 빠른 대응 |
| **재무팀** | 정확한 결제/환불 데이터, 정산 리포트 |

---

## 핵심 기능 (What We Deliver)

### 1. 주문 (Order)
- 유료 기능 사용 요청을 주문으로 생성
- 도메인에 종속되지 않는 설계 (메타데이터로 비즈니스 정보 전달)
- 주문 상태 추적: 대기 → 결제완료 → 서비스완료/취소

### 2. 결제 (Payment)
- PG사 연동 결제 처리 (카드, 간편결제)
- 결제 승인, 확정, 환불 지원
- 네트워크 오류 시 안전한 재시도

### 3. 크레딧 (Credit)
- 선불 충전 방식 (포인트, 토큰)
- 사용량 차감 및 환불
- 서비스별 차등 과금 정책

### 4. 구독 (Subscription)
- 월정액/연정액 구독
- 자동 갱신, 해지, 다운그레이드
- 무료 체험 기간 지원

### 5. 트래픽 제어
- 대기열 시스템으로 시스템 과부하 방지
- 요청량 제한으로 안정적인 서비스 운영

---

## 대표 시나리오 (Key Use Cases)

### 시나리오 1: 크레딧 선불 과금
```
1. 사용자가 크레딧 10,000원 충전 요청
2. FluxPay가 PG 결제 승인 → 크레딧 잔액 증가
3. 사용자가 서비스 이용 시 크레딧 차감
4. 잔액 부족 시 자동 충전 또는 결제 차단
```

### 시나리오 2: 구독 자동 갱신 + 환불
```
1. 월정액 구독 활성화 (무료 체험 7일)
2. 체험 종료 후 자동 결제 → 구독 갱신
3. 사용자 해지 요청 → 잔여 기간 비례 환불
4. 환불 완료 이벤트 → 클라이언트 서비스에 알림
```

---

## 성공 기준 (Measurable Outcomes)

| 목표 | 지표 | 기준 | 측정 방식 |
|------|------|------|----------|
| **높은 신뢰성** | 결제 성공률 | 99.9% 이상 | 월간 평균, PG 장애 제외 |
| **중복 결제 방지** | 중복 결제 발생 건수 | 0건 | 동일 멱등키로 2회 이상 과금된 건수 (월간) |
| **빠른 정합성 복구** | 장애 발생 후 데이터 일관성 회복 | 30초 이내 | Saga 보상 완료 시점 기준 |
| **빠른 응답** | API 응답 시간 | p95 < 200ms, p99 < 500ms | 결제 API 기준, 1,000 TPS 부하 조건 |
| **확장성** | 동시 처리량 | 1,000 TPS 이상 | k6 부하 테스트 기준 (3 pod, 4 core each) |
| **빠른 연동** | 신규 서비스 연동 소요 시간 | 1주일 이내 | SDK + 레퍼런스 구현 활용 시 |

---

## 구현 우선순위 (Roadmap)

### Phase 1: 핵심 결제 기능
**목표**: 기본 결제 흐름 완성

- 주문/결제 기능 구현
- PG 연동 (토스페이먼츠)
- 기본 크레딧 시스템
- API 문서화

### Phase 2: 안정성 강화
**목표**: 분산 환경에서 데이터 정합성 보장

- 이벤트 기반 아키텍처 도입
- 분산 트랜잭션 처리 (결제 실패 시 자동 롤백)
- 클라이언트 서비스 연동 테스트

### Phase 3: 트래픽 제어 & 구독
**목표**: 대규모 트래픽 대응 및 구독 모델 지원

- 대기열 시스템 (Virtual Waiting Room)
- 요청량 제한
- 구독 기능 구현
- 부하 테스트

### Phase 4: 운영 안정화
**목표**: 프로덕션 수준의 모니터링 및 알림

- 비즈니스 메트릭 대시보드
- 장애 알림 시스템
- 분산 추적
- SLA 리포트 자동화

---

## 범위 제외 (Out of Scope)

다음 기능은 FluxPay Engine의 현재 범위에 포함되지 않습니다:

| 기능 | 설명 | 대안 |
|------|------|------|
| **정산/대사** | PG 정산, 매출 인식, 리컨실리에이션 | Phase 2+ 로드맵 또는 외부 정산 시스템 연동 |
| **세금계산서/인보이싱** | 세금계산서 발행, 인보이스 관리 | 외부 ERP/회계 시스템 연동 |
| **차지백 처리** | 분쟁/이의제기 관리 | PG사 어드민 활용, 향후 확장 검토 |
| **멀티 PG 추상화** | 복수 PG사 자동 라우팅 | Phase 1은 토스페이먼츠 단일, 향후 확장 |
| **해외 결제** | 해외 카드, 페이팔 등 | 국내 결제 우선, 향후 확장 |

> 정산/대사 기능이 필요한 경우 [Technical Specification](./tech-spec.md)의 이벤트 스트리밍을 활용해 외부 정산 시스템과 연동할 수 있습니다.

---

## 비즈니스 제약 조건

| 제약 사항 | 이유 |
|-----------|------|
| 카드 정보 직접 저장 금지 | PCI-DSS 컴플라이언스, 보안 위험 최소화 |
| 클라이언트 코드 수정 최소화 | SDK, 레퍼런스 구현, API 문서로 빠른 연동 지원 |
| 결제 데이터 7년 보관 | 전자금융거래법 준수 (PII는 익명화/가명처리 후 보관) |
| 감사 로그 필수 | 모든 결제/환불 내역 추적 가능해야 함 |

---

## 연동 방식 개요

```
[클라이언트 서비스]
       │
       │ REST API (결제 요청)
       ▼
┌─────────────────┐
│  FluxPay Engine │ ──────▶ [PG사: 토스페이먼츠]
└─────────────────┘
       │
       │ 이벤트 (결제 완료 알림)
       ▼
[클라이언트 서비스]
```

- **요청**: 클라이언트 → FluxPay (REST API + X-Idempotency-Key)
- **알림**: FluxPay → 클라이언트 (CloudEvents 표준 이벤트 스트리밍)
- **설정**: YAML 기반 서비스별 과금 정책
- **연동 지원**: Java/Kotlin SDK, 레퍼런스 구현 제공

### API 요청/응답 예시

**결제 요청**:
```bash
POST /api/v1/payments
X-Tenant-Id: service-a
X-Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000
Content-Type: application/json
```

```json
{
  "orderId": "order_123456",
  "amount": 10000,
  "currency": "KRW",
  "paymentMethod": "CARD",
  "metadata": {
    "productName": "Premium Plan"
  }
}
```

**성공 응답**:
```json
{
  "success": true,
  "data": {
    "paymentId": "pay_abc123",
    "status": "APPROVED",
    "amount": {
      "value": 10000,
      "currency": "KRW"
    },
    "approvedAt": "2026-02-04T10:30:00Z"
  },
  "metadata": {
    "timestamp": "2026-02-04T10:30:00Z",
    "traceId": "trace-xyz-789"
  }
}
```

---

## 기술 상세 문서

기술 스택, 아키텍처 상세, API 스펙, 모니터링 설정 등은 [Technical Specification](./tech-spec.md) 참조.

---

*Last Updated: 2026-02-04*
