#!/bin/bash

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "Running pre-commit checks..."

# =============================================================================
# 1. COMMIT SIZE CHECK
# =============================================================================

MAX_LINES=400
MAX_FILES=10

# Get staged changes statistics
STAGED_LINES=$(git diff --cached --stat | tail -1 | grep -oE '[0-9]+ insertion|[0-9]+ deletion' | grep -oE '[0-9]+' | paste -sd+ - | bc 2>/dev/null || echo "0")
STAGED_FILES=$(git diff --cached --name-only | wc -l | tr -d ' ')

# Check for empty commit
if [ "$STAGED_FILES" -eq 0 ]; then
    echo -e "${YELLOW}Warning: No files staged for commit.${NC}"
    exit 0
fi

echo "Staged: $STAGED_FILES files, ~$STAGED_LINES lines changed"

# Warn if commit is too large (but allow override)
if [ "$STAGED_LINES" -gt "$MAX_LINES" ]; then
    echo ""
    echo -e "${YELLOW}WARNING: Large commit detected!${NC}"
    echo -e "  Lines changed: ${RED}$STAGED_LINES${NC} (recommended: ≤ $MAX_LINES)"
    echo ""
    echo "Consider breaking this into smaller commits:"
    echo "  - Separate test and implementation"
    echo "  - One feature/fix per commit"
    echo "  - Extract refactoring into separate commits"
    echo ""

    # Check if running in interactive mode
    if [ -t 0 ]; then
        read -p "Continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${RED}Commit aborted. Please break into smaller commits.${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}Non-interactive mode: proceeding with warning.${NC}"
    fi
fi

if [ "$STAGED_FILES" -gt "$MAX_FILES" ]; then
    echo ""
    echo -e "${YELLOW}WARNING: Many files changed!${NC}"
    echo -e "  Files changed: ${RED}$STAGED_FILES${NC} (recommended: ≤ $MAX_FILES)"
    echo ""
fi

# =============================================================================
# 2. FORBIDDEN PATTERNS CHECK
# =============================================================================

echo ""
echo "Checking for forbidden patterns..."

# Check for .block() in production code (not in tests)
BLOCK_VIOLATIONS=$(git diff --cached --name-only -- '*.java' | \
    grep -v "Test.java" | \
    xargs -I {} sh -c 'git show ":0:{}" 2>/dev/null | grep -n "\.block()" && echo "  in {}"' 2>/dev/null || true)

if [ -n "$BLOCK_VIOLATIONS" ]; then
    echo ""
    echo -e "${RED}ERROR: Found .block() in production code!${NC}"
    echo "$BLOCK_VIOLATIONS"
    echo ""
    echo "Use reactive operators instead. See CLAUDE.md for patterns."
    exit 1
fi

# Check for empty catch blocks
EMPTY_CATCH=$(git diff --cached -- '*.java' | grep -E "catch\s*\([^)]+\)\s*\{\s*\}" || true)
if [ -n "$EMPTY_CATCH" ]; then
    echo ""
    echo -e "${RED}ERROR: Found empty catch block!${NC}"
    echo "$EMPTY_CATCH"
    echo ""
    echo "Always handle or log exceptions. See CLAUDE.md for patterns."
    exit 1
fi

echo -e "${GREEN}No forbidden patterns found.${NC}"

# =============================================================================
# 3. RUN TESTS
# =============================================================================

echo ""
echo "Running unit tests (excluding integration tests)..."

if ! ./gradlew test --console=plain -q -PexcludeIntegrationTests; then
    echo ""
    echo -e "${RED}Tests failed! Commit aborted.${NC}"
    echo "Please fix failing tests before committing."
    exit 1
fi

echo ""
echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
